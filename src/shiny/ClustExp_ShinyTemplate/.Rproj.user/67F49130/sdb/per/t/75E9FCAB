{
    "collab_server" : "",
    "contents" : "#####################################\n## 09/2017 Justin Rajendra\n## Cluster Explorer\n## global\n\n### todo ###\n\nlibrary(shiny)\nlibrary(data.table)\nlibrary(shinydashboard)\nlibrary(plotly)\nlibrary(psych)\nlibrary(RColorBrewer)\nlibrary(afex)\n\n#################\n## change this stuff from the template\nprefix <- \"disco_crazy_MVM2\"\n# prefix <- 'prefix_replace'\n\n\n#################\n## load the stat functions and afni drivers\nsource('stat_functions.R')\nsource('afni_funk.R')\nsource('lib_Rafni.R')\n\n## find out where afni is\nafni.path <- dirname(system('which afni',intern=TRUE))\n\n####################################################\n## subjects and setup\n\n## read in stat info\nSI.df <- read.csv(paste0('data/',prefix,'_StatInfo.csv'))\n\n## selected p value\np_val <- as.character(SI.df$p_val)\n\n## table of extracted regions\nClustFile <- paste0(prefix,'_p_uncor_',p_val,'_clusters.csv')\nclust_all.df <- read.csv(paste0('data/',ClustFile))\n\n## group data from the history file\nGroupFile <-paste0(prefix,'_GroupTable.csv')\ngroup.df  <- read.csv(paste0('data/',GroupFile))\n\n## mean data extracted per subject\nMeanFile <- paste0(prefix,'_p_uncor_',p_val,'_mean.csv')\nmean.df  <- read.csv(paste0('data/',MeanFile),check.names=FALSE)\n\n## reshape to long and filter by subjects included from analysis\nmean.df <- melt(mean.df,variable.name='coord',id.vars=c('Subj','InputFile'))\nmean.df <- subset(mean.df,mean.df$InputFile %in% levels(group.df$InputFile))\n\n## merge with the group data\nmean.df <- merge(mean.df,group.df,by=c('InputFile','Subj'))\n\n## peak data extracted per subject\nPeakFile <- paste0(prefix,'_p_uncor_',p_val,'_peak.csv')\npeak.df  <- read.csv(paste0('data/',PeakFile),check.names=FALSE)\n\n## reshape to long and filter by subjects included from analysis\npeak.df <- melt(peak.df,variable.name='coord',id.vars=c('Subj','InputFile'))\npeak.df <- subset(peak.df,peak.df$InputFile %in% levels(group.df$InputFile))\n\n## merge with the group data\npeak.df <- merge(peak.df,group.df,by=c('InputFile','Subj'))\n\n##### add check for subjects in group match #####\n\n## images\nunderImage <- paste0('data/',prefix,'_master.nii.gz')\nthreshImage <- paste0('data/',prefix,'_p_uncor_',p_val,'.nii.gz')\nmaskImage <- paste0('data/',prefix,'_p_uncor_',p_val,'_mask.nii.gz')\npeakImage <- paste0('data/',prefix,'_p_uncor_',p_val,'_peak_mask.nii.gz')\natlas.name <- SI.df$atlas\n\n####################################################\n## cluster lists\n\n## cluster location, center of mass\nclust.cm.lab <- ifelse(is.na(clust_all.df$label_cm),\n                       as.character(clust_all.df$x_y_z_cm),\n                       as.character(clust_all.df$label_cm))\n\nclust.cm.list <- as.list(as.character(clust_all.df$x_y_z_cm))\nnames(clust.cm.list) <- clust.cm.lab\n\n## cluster location, peak\nclust.pk.lab <- ifelse(is.na(clust_all.df$label_peak),\n                       as.character(clust_all.df$x_y_z_peak),\n                       as.character(clust_all.df$label_peak))\n\nclust.pk.list <- as.list(as.character(clust_all.df$x_y_z_peak))\nnames(clust.pk.list) <- clust.pk.lab\n\n####################################################\n## need these later\nwsVars <- NA\nqVars <- NA\nmvm.vars <- NA\nno.interaction <- TRUE\n\n####################################################\n## mvm info\nif(SI.df$test == \"3dMVM\"){\n\n  ## get the full model and split out the variables\n  mvm.model <- gsub(\"'\", '', SI.df$model)\n  mvm.vars <- unlist(tstrsplit(mvm.model, '[*+/-]'))\n\n  ## get categorical variables (first and last are Subj and InputFile)\n  catVars <- c(names(group.df)[sapply(group.df,is.factor)])\n  if(length(catVars) > 2){\n    catVars <- catVars[3:length(catVars)-1]\n    if(length(catVars) >= 2){ no.interaction <- FALSE }\n  } else {\n    catVars <- \"None\"\n  }  ## end catVars\n\n  ## quantitative variables\n  qVars <- c(names(group.df)[sapply(group.df,is.numeric)])\n  if(length(qVars) == 0){ qVars <- NA }\n\n  ######################\n  ## verify within subject factors\n  if(!(\"None\" %in% catVars)){\n\n    wsVars.model <- NA\n\n    ## custom function, takes data frame and position of the 'Subj' column\n    wsVars <- wsVarCatFinder(group.df,1)\n    if(!anyNA(wsVars)){\n\n      ## get rid of \"InputFile\"\n      wsVars <- wsVars[1:length(wsVars)-1]\n\n      ## remove the wsVars from catVars\n      catVars <- catVars[which(!(catVars%in%wsVars))]\n      if(length(catVars) < 1){ catVars <- \"None\" }\n\n      ## get the first one from the 3dMVM code to the top\n      if(!is.na(SI.df$wsVars)){\n        ## break down wsVars model and split\n        wsVars.model <- gsub(\"'\", '', SI.df$wsVars)\n        wsVars.spec <- unlist(tstrsplit(wsVars.model, '[*+/-]'))\n        wsVars <- c(wsVars.spec[1],wsVars[wsVars != wsVars.spec[1]])\n      }\n    }\n  }   ## end wsVars\n\n} else if(SI.df$test == \"Ttest\"){\n\n  ## match the order\n  if(SI.df$model == \"AB\"){\n    lab.a <- as.character(SI.df$setA)\n    lab.b <- as.character(SI.df$setB)\n  } else if(SI.df$model == \"BA\"){\n    lab.a <- as.character(SI.df$setB)\n    lab.b <- as.character(SI.df$setA)\n  }\n\n  ## reorder the factor levels\n  mean.df$Group <- factor(mean.df$Group,levels=c(lab.a,lab.b),ordered=TRUE)\n  peak.df$Group <- factor(peak.df$Group,levels=c(lab.a,lab.b),ordered=TRUE)\n\n  catVars <- paste0(lab.a,'-',lab.b)\n  names(catVars) <- catVars\n\n}   ## end variable names\n\n## launch afni\nafni_launch(underImage,threshImage,maskImage,peakImage)\n",
    "created" : 1505921357531.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2661129695",
    "id" : "75E9FCAB",
    "lastKnownWriteTime" : 1505923679,
    "last_content_update" : 1505923679156,
    "path" : "~/research/ClusterExplorer/ClustExp_ShinyTemplate/global.R",
    "project_path" : "global.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}