FROM ubuntu:bionic-20180526@sha256:c8c275751219dadad8fa56b3ac41ca6cb22219ff117ca98fe82b42f24e1ba64e

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update -y -qq \
    && apt-get install -yq --no-install-recommends \
          ca-certificates \
          curl \
          g++ \
          gcc \
          git \
          libglib2.0-dev \
          libglu1-mesa-dev \
          libglw1-mesa-dev \
          libgsl-dev \
          libmotif-dev \
          libxi-dev \
          libxmhtml-dev \
          libxmu-dev \
          libxpm-dev \
          libxt-dev \
          m4 \
          python-qt4 \
          r-base \
          tcsh \
          vim \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install pip.
RUN curl -fsSL https://bootstrap.pypa.io/get-pip.py | python3 - --no-cache-dir \
    && pip install --no-cache-dir --quiet \
          codecov \
          pytest \
          pytest-cov

# Copy AFNI source code. This can invalidate the build cache.
ARG AFNI_ROOT=/opt/afni
COPY [".", "$AFNI_ROOT/"]

# NOTE(kaczmarj): I don't think we should checkout in the Dockerfile. The user
# should checkout their local copy of the code and then build. The local copy
# is checked out to the desired version anyway.

ARG AFNI_MAKEFILE_SUFFIX=linux_ubuntu_16_64
WORKDIR "$AFNI_ROOT/src"
RUN \
    # Add coverage flags to Makefile.
    sed -i 's/# CPROF = /CPROF =  -coverage /' Makefile.$AFNI_MAKEFILE_SUFFIX \
    \
    # Clean AFNI src directory (*.o files can cause build to fail).
    && make -f  Makefile.$AFNI_MAKEFILE_SUFFIX afni_src.tgz \
    && mv afni_src.tgz .. \
    && cd .. \
    \
    # Empty the src directory, and replace with the contents of afni_src.tgz
    && rm -rf src/ && mkdir src \
    && tar -xzf afni_src.tgz -C $AFNI_ROOT/src --strip-components=1 \
    && rm afni_src.tgz \
    \
    # Build AFNI.
    && cd src \
    && cp Makefile.$AFNI_MAKEFILE_SUFFIX Makefile \
    && make itall \
    && mv $AFNI_MAKEFILE_SUFFIX $AFNI_ROOT/bin

ENV PATH="$AFNI_ROOT/bin:$PATH"
WORKDIR "$AFNI_ROOT"
